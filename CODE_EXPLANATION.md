# GuardReasoner ä»£ç æ–‡ä»¶è¯´æ˜ï¼ˆé›¶åŸºç¡€ç‰ˆï¼‰

## ğŸ“š é¡¹ç›®æ¦‚è¿°

è¿™ä¸ªé¡¹ç›®å®ç°äº† GuardReasoner è®ºæ–‡çš„å¤ç°ï¼ŒåŒ…æ‹¬ï¼š
1. **åŸºç¡€æ¨¡å‹è¯„ä¼°**ï¼ˆå¤ç°è®ºæ–‡ç»“æœï¼‰
2. **RAGå¢å¼ºè¯„ä¼°**ï¼ˆæ·»åŠ æ£€ç´¢å¢å¼ºç”ŸæˆåŠŸèƒ½ï¼‰

---

## ğŸ¯ æ ¸å¿ƒæ–‡ä»¶ï¼ˆå¿…é¡»ä¿ç•™ï¼‰

### 1. **generate.py** - åŸè®ºæ–‡çš„ç”Ÿæˆè„šæœ¬
**ä½œç”¨**ï¼šä½¿ç”¨åŸè®ºæ–‡ä½œè€…æä¾›çš„æ¨¡å‹ç”Ÿæˆæ‰€æœ‰æ•°æ®é›†çš„é¢„æµ‹ç»“æœ
- æ”¯æŒ 1Bã€3Bã€8B ä¸‰ä¸ªæ¨¡å‹å¤§å°
- æ”¯æŒ 11 ä¸ªä¸åŒçš„æµ‹è¯•æ•°æ®é›†
- ä½¿ç”¨ HuggingFace ä¸Šçš„å®˜æ–¹æ¨¡å‹ï¼š`yueliu1999/GuardReasoner-{size}`

**ä½•æ—¶ä½¿ç”¨**ï¼šæƒ³è¦å¤ç°åŸè®ºæ–‡çš„å®Œæ•´ç»“æœæ—¶

---

### 2. **evaluate.py** - åŸè®ºæ–‡çš„è¯„ä¼°è„šæœ¬
**ä½œç”¨**ï¼šè¯„ä¼°æ‰€æœ‰æ•°æ®é›†çš„æ€§èƒ½ï¼ˆä¸åŸè®ºæ–‡æ–¹æ³•ä¸€è‡´ï¼‰
- ä½¿ç”¨æœ€å300å­—ç¬¦æå–æ ‡ç­¾
- è®¡ç®— F1ã€Precisionã€Recall ç­‰æŒ‡æ ‡
- æ”¯æŒæ‰€æœ‰ 11 ä¸ªæµ‹è¯•æ•°æ®é›†

**ä½•æ—¶ä½¿ç”¨**ï¼šè¯„ä¼°åŸè®ºæ–‡æ¨¡å‹çš„æ€§èƒ½æ—¶

---

### 3. **generate_wildguard.py** - WildGuardTest ç”Ÿæˆï¼ˆæ— RAGï¼‰
**ä½œç”¨**ï¼šä¸“é—¨ä¸º WildGuardTest ç”Ÿæˆé¢„æµ‹ï¼Œä¸ä½¿ç”¨ RAG
- ç”¨äºå¯¹æ¯”å®éªŒï¼ˆNoRAG vs WithRAGï¼‰
- è¾“å‡ºåˆ°ï¼š`./data/test/1B/WildGuardTest_HSDPO_NoRAG/`

**ä½•æ—¶ä½¿ç”¨**ï¼šç”Ÿæˆä¸å¸¦RAGçš„åŸºå‡†é¢„æµ‹æ—¶

**å‘½ä»¤è¡Œ**ï¼š
```bash
python3 generate_wildguard.py \
    --model_path "6Amber6/GuardReasoner-1B-HS-DPO" \
    --output_dir "./data/test/1B/WildGuardTest_HSDPO_NoRAG"
```

---

### 4. **evaluate_wildguard.py** - WildGuardTest è¯„ä¼°ï¼ˆä¿®å¤ç‰ˆï¼‰
**ä½œç”¨**ï¼šè¯„ä¼° WildGuardTest æ•°æ®é›†ï¼Œæ”¯æŒ NoRAG å’Œ WithRAG å¯¹æ¯”
- **å·²ä¿®å¤**ï¼šåªä½¿ç”¨æœ€å300å­—ç¬¦æå–æ ‡ç­¾ï¼ˆä¸åŸè®ºæ–‡ä¸€è‡´ï¼‰
- æ”¯æŒä¸‰ä¸ªä»»åŠ¡ï¼šPrompt Harmfulnessã€Response Harmfulnessã€Refusal Detection
- è¾“å‡ºè¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡

**ä½•æ—¶ä½¿ç”¨**ï¼šè¯„ä¼° WildGuardTest ç»“æœæ—¶ï¼ˆæœ€å¸¸ç”¨ï¼‰

**å‘½ä»¤è¡Œ**ï¼š
```bash
python3 evaluate_wildguard.py --folders \
    ./data/test/1B/WildGuardTest_HSDPO_NoRAG/ \
    ./data/test/1B/WildGuardTest_HSDPO_WithRAG/
```

---

### 5. **build_rag_knowledge_base.py** - æ„å»ºRAGçŸ¥è¯†åº“
**ä½œç”¨**ï¼šä»è®­ç»ƒæ•°æ®æ„å»ºRAGæ£€ç´¢çŸ¥è¯†åº“
- è¯»å–è®­ç»ƒæ•°æ®ï¼šWildGuardTrainRã€AegisTrainRã€BeaverTailsTrainRã€ToxicChatTrainR
- ä½¿ç”¨ `all-MiniLM-L6-v2` æ¨¡å‹ç”Ÿæˆæ–‡æœ¬åµŒå…¥
- ä¿å­˜ä¸ºï¼š`./rag_knowledge_base/knowledge_base.pkl`

**ä½•æ—¶ä½¿ç”¨**ï¼šç¬¬ä¸€æ¬¡ä½¿ç”¨RAGåŠŸèƒ½å‰ï¼Œæˆ–è®­ç»ƒæ•°æ®æ›´æ–°å

**å‘½ä»¤è¡Œ**ï¼š
```bash
python3 build_rag_knowledge_base.py
```

---

### 6. **generate_with_rag.py** - RAGå¢å¼ºç”Ÿæˆ
**ä½œç”¨**ï¼šä½¿ç”¨RAGå¢å¼ºæ¨¡å‹ç”Ÿæˆé¢„æµ‹
- ä»çŸ¥è¯†åº“æ£€ç´¢ç›¸ä¼¼æ¡ˆä¾‹
- å°†æ£€ç´¢åˆ°çš„æ¡ˆä¾‹ä½œä¸ºä¸Šä¸‹æ–‡æ·»åŠ åˆ°æç¤ºä¸­
- ç”ŸæˆRAGå¢å¼ºçš„é¢„æµ‹ç»“æœ

**å‚æ•°**ï¼š
- `--model_path`: æ¨¡å‹è·¯å¾„
- `--output_dir`: è¾“å‡ºç›®å½•
- `--use_rag`: å¯ç”¨RAG
- `--top_k`: æ£€ç´¢çš„æ¡ˆä¾‹æ•°é‡ï¼ˆé»˜è®¤1ï¼‰
- `--similarity_threshold`: ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆé»˜è®¤0.7ï¼‰

**ä½•æ—¶ä½¿ç”¨**ï¼šç”Ÿæˆå¸¦RAGçš„é¢„æµ‹æ—¶

**å‘½ä»¤è¡Œ**ï¼š
```bash
python3 generate_with_rag.py \
    --model_path "6Amber6/GuardReasoner-1B-HS-DPO" \
    --output_dir "./data/test/1B/WildGuardTest_HSDPO_WithRAG" \
    --use_rag
```

---

### 7. **download_train_data.py** - ä¸‹è½½è®­ç»ƒæ•°æ®
**ä½œç”¨**ï¼šä» HuggingFace ä¸‹è½½è®­ç»ƒæ•°æ®ç”¨äºæ„å»ºRAGçŸ¥è¯†åº“
- ä¸‹è½½ 4 ä¸ªè®­ç»ƒæ•°æ®é›†
- ä¿å­˜åˆ° `./data/` ç›®å½•

**ä½•æ—¶ä½¿ç”¨**ï¼šç¬¬ä¸€æ¬¡æ„å»ºRAGçŸ¥è¯†åº“å‰

**å‘½ä»¤è¡Œ**ï¼š
```bash
python3 download_train_data.py
```

---

### 8. **template.py** - æç¤ºæ¨¡æ¿
**ä½œç”¨**ï¼šå®šä¹‰æ¨¡å‹è¾“å…¥è¾“å‡ºçš„æ ¼å¼æ¨¡æ¿
- `WILDGUARD_INPUT_FORMAT`: è¾“å…¥æ ¼å¼
- `WILDGUARD_OUTPUT_FORMAT`: è¾“å‡ºæ ¼å¼
- `INSTRUCTION`: æŒ‡ä»¤æ¨¡æ¿

**ä½•æ—¶ä½¿ç”¨**ï¼šè¢«å…¶ä»–è„šæœ¬å¯¼å…¥ä½¿ç”¨ï¼ˆä¸éœ€è¦ç›´æ¥è¿è¡Œï¼‰

---

## ğŸ”§ è¾…åŠ©è„šæœ¬ï¼ˆå¯é€‰ï¼‰

### 9. **run_rag_evaluation.py** - RAGè¯„ä¼°æµç¨‹
**ä½œç”¨**ï¼šä¸€é”®è¿è¡Œå®Œæ•´çš„RAGè¯„ä¼°æµç¨‹
- æ£€æŸ¥ä¾èµ–
- æ„å»ºçŸ¥è¯†åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
- ç”ŸæˆNoRAGé¢„æµ‹
- ç”ŸæˆWithRAGé¢„æµ‹
- è¯„ä¼°å¹¶å¯¹æ¯”ç»“æœ

**ä½•æ—¶ä½¿ç”¨**ï¼šæƒ³è¦ä¸€é”®å®Œæˆæ‰€æœ‰RAGç›¸å…³æ“ä½œæ—¶

**å‘½ä»¤è¡Œ**ï¼š
```bash
python3 run_rag_evaluation.py
```

---

### 10. **run_all.py** - å®Œæ•´è¯„ä¼°æµç¨‹
**ä½œç”¨**ï¼šè¿è¡ŒRSFTå’ŒHSDPOæ¨¡å‹çš„å®Œæ•´è¯„ä¼°
- ç”Ÿæˆä¸¤ä¸ªæ¨¡å‹çš„é¢„æµ‹
- è¯„ä¼°æ€§èƒ½
- å¯¹æ¯”ç»“æœ

**ä½•æ—¶ä½¿ç”¨**ï¼šè¯„ä¼°RSFTå’ŒHSDPOæ¨¡å‹æ—¶

---

### 11. **deploy.py** - æ¨¡å‹éƒ¨ç½²
**ä½œç”¨**ï¼šéƒ¨ç½²æ¨¡å‹ä¸ºAPIæœåŠ¡ï¼ˆç”¨äºå®é™…åº”ç”¨ï¼‰

**ä½•æ—¶ä½¿ç”¨**ï¼šéœ€è¦å°†æ¨¡å‹éƒ¨ç½²ä¸ºæœåŠ¡æ—¶

---

## ğŸ“ Shellè„šæœ¬ï¼ˆè¾…åŠ©å·¥å…·ï¼‰

### 12. **quick_evaluate.sh** - å¿«é€Ÿè¯„ä¼°
**ä½œç”¨**ï¼šå¿«é€Ÿè¯„ä¼°RAGç»“æœ

### 13. **quick_start_rag.sh** - å¿«é€Ÿå¯åŠ¨RAG
**ä½œç”¨**ï¼šä¸€é”®å¯åŠ¨RAGè¯„ä¼°æµç¨‹

### 14. **run_rag_regenerate.sh** - é‡æ–°ç”ŸæˆRAGé¢„æµ‹
**ä½œç”¨**ï¼šåˆ é™¤æ—§çš„RAGé¢„æµ‹å¹¶é‡æ–°ç”Ÿæˆ

---

## ğŸ—‘ï¸ å·²åˆ é™¤çš„æ–‡ä»¶

ä»¥ä¸‹æ–‡ä»¶å·²è¢«åˆ é™¤ï¼ˆä¸å†éœ€è¦ï¼‰ï¼š

1. **rag-work-flow** - ä¸´æ—¶æµç¨‹å›¾æ–‡ä»¶ï¼ˆå·²åˆ é™¤ï¼‰
2. **run_evaluation.sh** - å·²è¿‡æ—¶çš„è¯„ä¼°è„šæœ¬ï¼ˆå·²åˆ é™¤ï¼Œä½¿ç”¨ `run_rag_evaluation.py` æ›¿ä»£ï¼‰

---

## ğŸ“– å…¸å‹å·¥ä½œæµç¨‹

### åœºæ™¯1ï¼šå¤ç°åŸè®ºæ–‡ç»“æœ
```bash
# 1. ç”Ÿæˆæ‰€æœ‰æ•°æ®é›†çš„é¢„æµ‹
python3 generate.py

# 2. è¯„ä¼°æ‰€æœ‰æ•°æ®é›†
python3 evaluate.py
```

### åœºæ™¯2ï¼šè¯„ä¼°WildGuardTestï¼ˆNoRAG vs WithRAGï¼‰
```bash
# 1. ä¸‹è½½è®­ç»ƒæ•°æ®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
python3 download_train_data.py

# 2. æ„å»ºRAGçŸ¥è¯†åº“ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
python3 build_rag_knowledge_base.py

# 3. ç”ŸæˆNoRAGé¢„æµ‹
python3 generate_wildguard.py \
    --model_path "6Amber6/GuardReasoner-1B-HS-DPO" \
    --output_dir "./data/test/1B/WildGuardTest_HSDPO_NoRAG"

# 4. ç”ŸæˆWithRAGé¢„æµ‹
python3 generate_with_rag.py \
    --model_path "6Amber6/GuardReasoner-1B-HS-DPO" \
    --output_dir "./data/test/1B/WildGuardTest_HSDPO_WithRAG" \
    --use_rag

# 5. è¯„ä¼°å¹¶å¯¹æ¯”
python3 evaluate_wildguard.py --folders \
    ./data/test/1B/WildGuardTest_HSDPO_NoRAG/ \
    ./data/test/1B/WildGuardTest_HSDPO_WithRAG/
```

### åœºæ™¯3ï¼šä¸€é”®è¿è¡ŒRAGè¯„ä¼°
```bash
python3 run_rag_evaluation.py
```

---

## ğŸ“ ç›®å½•ç»“æ„è¯´æ˜

```
GuardReasoner/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ benchmark/          # æµ‹è¯•æ•°æ®é›†ï¼ˆ11ä¸ªæ•°æ®é›†ï¼‰
â”‚   â”œâ”€â”€ test/              # ç”Ÿæˆçš„é¢„æµ‹ç»“æœ
â”‚   â”‚   â”œâ”€â”€ 1B/           # 1Bæ¨¡å‹çš„é¢„æµ‹
â”‚   â”‚   â”œâ”€â”€ 3B/           # 3Bæ¨¡å‹çš„é¢„æµ‹
â”‚   â”‚   â””â”€â”€ 8B/           # 8Bæ¨¡å‹çš„é¢„æµ‹
â”‚   â””â”€â”€ *.json            # è®­ç»ƒæ•°æ®ï¼ˆç”¨äºRAGçŸ¥è¯†åº“ï¼‰
â”œâ”€â”€ rag_knowledge_base/    # RAGçŸ¥è¯†åº“ï¼ˆæ„å»ºåç”Ÿæˆï¼‰
â”œâ”€â”€ train/                 # è®­ç»ƒç›¸å…³è„šæœ¬ï¼ˆå¦‚æœéœ€è¦è®­ç»ƒæ¨¡å‹ï¼‰
â””â”€â”€ *.py                  # Pythonè„šæœ¬
```

---

## âš ï¸ é‡è¦æç¤º

1. **è¯„ä¼°æ–¹æ³•**ï¼š`evaluate_wildguard.py` å·²ä¿®å¤ï¼Œç°åœ¨åªä½¿ç”¨æœ€å300å­—ç¬¦æå–æ ‡ç­¾ï¼Œä¸åŸè®ºæ–‡æ–¹æ³•ä¸€è‡´
2. **æ¨¡å‹è·¯å¾„**ï¼šå¦‚æœä½¿ç”¨è‡ªå·±çš„æ¨¡å‹ï¼Œéœ€è¦ä¿®æ”¹æ¨¡å‹è·¯å¾„å‚æ•°
3. **GPUå†…å­˜**ï¼šå¦‚æœé‡åˆ°OOMé”™è¯¯ï¼Œå¯ä»¥é™ä½ `gpu_memory_utilization` å‚æ•°
4. **RAGçŸ¥è¯†åº“**ï¼šç¬¬ä¸€æ¬¡ä½¿ç”¨RAGå‰å¿…é¡»æ„å»ºçŸ¥è¯†åº“

