# RAGè¯„ä¼°å®Œæ•´æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ å®Œæˆåœ¨GuardReasoner HSDPOæ¨¡å‹ä¸Šæ·»åŠ RAGï¼ˆRetrieval-Augmented Generationï¼‰ï¼Œå¹¶è¯„ä¼°åŠ RAGå’Œä¸åŠ RAGçš„å¯¹æ¯”æ•ˆæœã€‚

## ğŸ“‹ ç›®å½•

1. [ä»€ä¹ˆæ˜¯RAGï¼Ÿ](#ä»€ä¹ˆæ˜¯rag)
2. [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
3. [å®Œæ•´æ­¥éª¤](#å®Œæ•´æ­¥éª¤)
4. [ç»“æœè§£è¯»](#ç»“æœè§£è¯»)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ¯ ä»€ä¹ˆæ˜¯RAGï¼Ÿ

**RAG (Retrieval-Augmented Generation)** æ˜¯ä¸€ç§å¢å¼ºå¤§è¯­è¨€æ¨¡å‹çš„æ–¹æ³•ï¼š

1. **æ£€ç´¢ï¼ˆRetrievalï¼‰**ï¼šä»çŸ¥è¯†åº“ä¸­æ£€ç´¢ä¸å½“å‰è¾“å…¥æœ€ç›¸å…³çš„ç¤ºä¾‹
2. **å¢å¼ºï¼ˆAugmentationï¼‰**ï¼šå°†æ£€ç´¢åˆ°çš„ç¤ºä¾‹æ·»åŠ åˆ°è¾“å…¥promptä¸­
3. **ç”Ÿæˆï¼ˆGenerationï¼‰**ï¼šæ¨¡å‹åŸºäºå¢å¼ºåçš„promptç”Ÿæˆç­”æ¡ˆ

åœ¨GuardReasonerä¸­ï¼ŒRAGçš„ä½œç”¨æ˜¯ï¼š
- ä»è®­ç»ƒæ•°æ®ä¸­æ£€ç´¢ç›¸ä¼¼çš„æ¨ç†ç¤ºä¾‹
- å¸®åŠ©æ¨¡å‹æ›´å¥½åœ°ç†è§£å¦‚ä½•è¿›è¡Œåˆ†ç±»å’Œæ¨ç†
- æé«˜æ¨¡å‹åœ¨WildGuardTestä¸Šçš„è¡¨ç°

---

## ğŸ”§ å‡†å¤‡å·¥ä½œ

### 1. æ£€æŸ¥ä¾èµ–

ç¡®ä¿å·²å®‰è£…ä»¥ä¸‹PythonåŒ…ï¼š

```bash
pip install vllm sentence-transformers numpy pandas scikit-learn
```

### 2. æ£€æŸ¥æ¨¡å‹è·¯å¾„

ç¡®ä¿ä½ çš„HSDPOæ¨¡å‹è·¯å¾„æ­£ç¡®ã€‚é»˜è®¤ä½¿ç”¨HuggingFaceæ¨¡å‹ï¼š
- `6Amber6/GuardReasoner-1B-HS-DPO`

å¦‚æœéœ€è¦ä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼Œè¯·ä¿®æ”¹ `run_rag_evaluation.py` ä¸­çš„ `HSDPO_MODEL_PATH`ã€‚

### 3. æ£€æŸ¥æ•°æ®æ–‡ä»¶

ç¡®ä¿æµ‹è¯•æ•°æ®å­˜åœ¨ï¼š
```bash
ls ./data/benchmark/0_4_wild_guard_test.json
```

---

## ğŸš€ å®Œæ•´æ­¥éª¤

### æ–¹æ³•ä¸€ï¼šä¸€é”®è¿è¡Œï¼ˆæ¨èï¼‰

æœ€ç®€å•çš„æ–¹å¼æ˜¯è¿è¡Œä¸€é”®è„šæœ¬ï¼š

```bash
python run_rag_evaluation.py
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆæ‰€æœ‰æ­¥éª¤ï¼š
1. âœ… æ£€æŸ¥ä¾èµ–
2. âœ… æ„å»ºRAGçŸ¥è¯†åº“
3. âœ… ç”Ÿæˆä¸å¸¦RAGçš„é¢„æµ‹
4. âœ… ç”Ÿæˆå¸¦RAGçš„é¢„æµ‹
5. âœ… è¯„ä¼°å¹¶å¯¹æ¯”ç»“æœ

### æ–¹æ³•äºŒï¼šåˆ†æ­¥è¿è¡Œ

å¦‚æœä½ æƒ³æ›´ç²¾ç»†åœ°æ§åˆ¶æ¯ä¸ªæ­¥éª¤ï¼Œå¯ä»¥æ‰‹åŠ¨è¿è¡Œï¼š

#### æ­¥éª¤1: æ„å»ºRAGçŸ¥è¯†åº“

```bash
python build_rag_knowledge_base.py
```

**è¯´æ˜**ï¼š
- å¦‚æœè®­ç»ƒæ•°æ®å­˜åœ¨ï¼ˆ`./data/WildGuardTrainR.json`ç­‰ï¼‰ï¼Œä¼šä½¿ç”¨è®­ç»ƒæ•°æ®
- å¦‚æœè®­ç»ƒæ•°æ®ä¸å­˜åœ¨ï¼Œä¼šä½¿ç”¨benchmarkæ•°æ®ä½œä¸ºç¤ºä¾‹
- çŸ¥è¯†åº“ä¼šä¿å­˜åœ¨ `./rag_knowledge_base/knowledge_base.pkl`

**é¢„æœŸè¾“å‡º**ï¼š
```
Loading embedding model...
Processing ./data/benchmark/0_4_wild_guard_test.json...
Total knowledge items: 1725
Generating embeddings...
Knowledge base saved to ./rag_knowledge_base
```

#### æ­¥éª¤2: ç”Ÿæˆä¸å¸¦RAGçš„é¢„æµ‹

```bash
python generate_wildguard.py \
    --model_path "6Amber6/GuardReasoner-1B-HS-DPO" \
    --output_dir "./data/test/1B/WildGuardTest_HSDPO_NoRAG"
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨HSDPOæ¨¡å‹ç”Ÿæˆé¢„æµ‹ï¼Œä¸ä½¿ç”¨RAG
- ç»“æœä¿å­˜åœ¨ `./data/test/1B/WildGuardTest_HSDPO_NoRAG/generated_predictions.jsonl`

#### æ­¥éª¤3: ç”Ÿæˆå¸¦RAGçš„é¢„æµ‹

```bash
python generate_with_rag.py \
    --model_path "6Amber6/GuardReasoner-1B-HS-DPO" \
    --output_dir "./data/test/1B/WildGuardTest_HSDPO_WithRAG" \
    --use_rag \
    --top_k 3
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨HSDPOæ¨¡å‹ç”Ÿæˆé¢„æµ‹ï¼Œ**ä½¿ç”¨RAGå¢å¼º**
- `--top_k 3` è¡¨ç¤ºæ£€ç´¢æœ€ç›¸å…³çš„3ä¸ªç¤ºä¾‹
- ç»“æœä¿å­˜åœ¨ `./data/test/1B/WildGuardTest_HSDPO_WithRAG/generated_predictions.jsonl`

#### æ­¥éª¤4: è¯„ä¼°å¹¶å¯¹æ¯”

```bash
python evaluate_wildguard.py --folders \
    "./data/test/1B/WildGuardTest_HSDPO_NoRAG/" \
    "./data/test/1B/WildGuardTest_HSDPO_WithRAG/"
```

**è¯´æ˜**ï¼š
- è¯„ä¼°ä¸¤ä¸ªæ–‡ä»¶å¤¹ä¸­çš„é¢„æµ‹ç»“æœ
- ä¼šæ˜¾ç¤ºæ¯ä¸ªä»»åŠ¡çš„F1ã€Precisionã€Recallã€Accuracy
- ä¼šæ˜¾ç¤ºValidå’ŒSkippedæ ·æœ¬æ•°

---

## ğŸ“Š ç»“æœè§£è¯»

### è¯„ä¼°æŒ‡æ ‡è¯´æ˜

- **F1 Score**: ç²¾ç¡®ç‡å’Œå¬å›ç‡çš„è°ƒå’Œå¹³å‡æ•°ï¼Œç»¼åˆè¯„ä¼°æŒ‡æ ‡
- **Precision**: ç²¾ç¡®ç‡ï¼Œé¢„æµ‹ä¸ºæ­£ä¾‹ä¸­çœŸæ­£ä¸ºæ­£ä¾‹çš„æ¯”ä¾‹
- **Recall**: å¬å›ç‡ï¼ŒçœŸæ­£ä¸ºæ­£ä¾‹ä¸­è¢«æ­£ç¡®é¢„æµ‹çš„æ¯”ä¾‹
- **Accuracy**: å‡†ç¡®ç‡ï¼Œæ‰€æœ‰é¢„æµ‹ä¸­æ­£ç¡®çš„æ¯”ä¾‹
- **Valid**: æˆåŠŸæå–æ ‡ç­¾çš„æ ·æœ¬æ•°
- **Skipped**: æ— æ³•æå–æ ‡ç­¾çš„æ ·æœ¬æ•°ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰

### ä¸‰ä¸ªä»»åŠ¡

1. **Prompt Harmfulness Detection**: æ£€æµ‹ç”¨æˆ·è¯·æ±‚æ˜¯å¦æœ‰å®³
2. **Response Harmfulness Detection**: æ£€æµ‹AIå›å¤æ˜¯å¦æœ‰å®³
3. **Refusal Detection**: æ£€æµ‹AIæ˜¯å¦æ‹’ç»å›ç­”

### å¯¹æ¯”ç»“æœç¤ºä¾‹

```
ã€å¯¹æ¯”ç»“æœï¼šRAG vs æ— RAGã€‘

ğŸ“Š PROMPT ä»»åŠ¡:
æŒ‡æ ‡             æ— RAG           æœ‰RAG           æå‡
F1               72.50           75.20           +2.70
Precision        70.30           73.10           +2.80
Recall           74.90           77.50           +2.60
Accuracy         85.20           87.10           +1.90
Valid            1720            1722            +2
Skipped          5               3               -2
```

**è§£è¯»**ï¼š
- å¦‚æœ"æå‡"åˆ—æ˜¯æ­£æ•°ï¼Œè¯´æ˜RAGæœ‰å¸®åŠ©
- å¦‚æœ"æå‡"åˆ—æ˜¯è´Ÿæ•°ï¼Œè¯´æ˜RAGå¯èƒ½æ²¡æœ‰å¸®åŠ©æˆ–éœ€è¦è°ƒæ•´
- Validè¶Šå¤šã€Skippedè¶Šå°‘è¶Šå¥½

---

## â“ å¸¸è§é—®é¢˜

### Q1: RAGçŸ¥è¯†åº“æ„å»ºå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

**A**: è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºéœ€è¦ï¼š
1. åŠ è½½embeddingæ¨¡å‹ï¼ˆé¦–æ¬¡ä¼šä¸‹è½½ï¼‰
2. ä¸ºæ‰€æœ‰çŸ¥è¯†é¡¹ç”Ÿæˆembeddingå‘é‡

**å»ºè®®**ï¼š
- é¦–æ¬¡è¿è¡Œä¼šä¸‹è½½æ¨¡å‹ï¼Œéœ€è¦ç½‘ç»œè¿æ¥
- æ„å»ºå®Œæˆåï¼ŒçŸ¥è¯†åº“ä¼šä¿å­˜ï¼Œä¸‹æ¬¡ä¸éœ€è¦é‡æ–°æ„å»º
- å¦‚æœè®­ç»ƒæ•°æ®å¾ˆå¤§ï¼Œå¯ä»¥è€ƒè™‘åªä½¿ç”¨éƒ¨åˆ†æ•°æ®

### Q2: ç”Ÿæˆé¢„æµ‹æ—¶å†…å­˜ä¸è¶³ï¼Ÿ

**A**: å¯ä»¥è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š

åœ¨ `generate_with_rag.py` ä¸­ï¼š
```python
vllm_model = LLM(
    model=model_path, 
    gpu_memory_utilization=0.8,  # é™ä½GPUå†…å­˜ä½¿ç”¨ç‡ï¼ˆé»˜è®¤0.95ï¼‰
    max_num_seqs=128              # é™ä½æ‰¹å¤„ç†å¤§å°ï¼ˆé»˜è®¤256ï¼‰
)
```

### Q3: RAGæ²¡æœ‰æå‡æ•ˆæœæ€ä¹ˆåŠï¼Ÿ

**A**: å¯èƒ½çš„åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼š

1. **çŸ¥è¯†åº“è´¨é‡ä¸é«˜**
   - æ£€æŸ¥è®­ç»ƒæ•°æ®æ˜¯å¦åŒ…å«é«˜è´¨é‡çš„æ¨ç†ç¤ºä¾‹
   - å°è¯•ä½¿ç”¨æ›´å¤šè®­ç»ƒæ•°æ®æ„å»ºçŸ¥è¯†åº“

2. **top_kè®¾ç½®ä¸å½“**
   - å°è¯•ä¸åŒçš„top_kå€¼ï¼ˆ1, 3, 5, 10ï¼‰
   - åœ¨ `generate_with_rag.py` ä¸­ä½¿ç”¨ `--top_k` å‚æ•°

3. **æ£€ç´¢è´¨é‡ä¸é«˜**
   - æ£€æŸ¥æ£€ç´¢åˆ°çš„ç¤ºä¾‹æ˜¯å¦çœŸçš„ç›¸å…³
   - å¯ä»¥æ·»åŠ è°ƒè¯•ä»£ç æŸ¥çœ‹æ£€ç´¢åˆ°çš„ç¤ºä¾‹

### Q4: å¦‚ä½•æŸ¥çœ‹æ£€ç´¢åˆ°çš„ç¤ºä¾‹ï¼Ÿ

**A**: å¯ä»¥åœ¨ `generate_with_rag.py` ä¸­æ·»åŠ è°ƒè¯•ä»£ç ï¼š

```python
# åœ¨ generate_with_rag å‡½æ•°ä¸­ï¼Œæ£€ç´¢åæ·»åŠ ï¼š
if i < 3:  # åªæ‰“å°å‰3ä¸ªæ ·æœ¬
    print(f"\næ ·æœ¬ {i+1} æ£€ç´¢åˆ°çš„ç¤ºä¾‹:")
    for j, item in enumerate(retrieved_items):
        print(f"  ç¤ºä¾‹ {j+1}: {item['input'][:100]}...")
```

### Q5: å¯ä»¥ä½¿ç”¨ä¸åŒçš„embeddingæ¨¡å‹å—ï¼Ÿ

**A**: å¯ä»¥ï¼Œåœ¨ `build_rag_knowledge_base.py` ä¸­ä¿®æ”¹ï¼š

```python
# å½“å‰ä½¿ç”¨è½»é‡çº§æ¨¡å‹
encoder = SentenceTransformer('all-MiniLM-L6-v2')

# å¯ä»¥ä½¿ç”¨æ›´å¼ºå¤§çš„æ¨¡å‹ï¼ˆä½†ä¼šæ›´æ…¢ï¼‰
encoder = SentenceTransformer('all-mpnet-base-v2')
```

### Q6: å¦‚ä½•åªè¯„ä¼°ç‰¹å®šä»»åŠ¡ï¼Ÿ

**A**: å¯ä»¥ä¿®æ”¹ `evaluate_wildguard.py`ï¼Œæˆ–è€…ç›´æ¥æŸ¥çœ‹è¾“å‡ºç»“æœä¸­çš„ç‰¹å®šä»»åŠ¡éƒ¨åˆ†ã€‚

---

## ğŸ“ æ–‡ä»¶ç»“æ„

å®Œæˆæ‰€æœ‰æ­¥éª¤åï¼Œä½ çš„æ–‡ä»¶ç»“æ„åº”è¯¥æ˜¯ï¼š

```
GuardReasoner/
â”œâ”€â”€ run_rag_evaluation.py          # ä¸€é”®è¿è¡Œè„šæœ¬ï¼ˆæ¨èï¼‰
â”œâ”€â”€ build_rag_knowledge_base.py    # RAGçŸ¥è¯†åº“æ„å»ºè„šæœ¬
â”œâ”€â”€ generate_wildguard.py          # ä¸å¸¦RAGçš„ç”Ÿæˆè„šæœ¬
â”œâ”€â”€ generate_with_rag.py           # å¸¦RAGçš„ç”Ÿæˆè„šæœ¬
â”œâ”€â”€ evaluate_wildguard.py          # è¯„ä¼°è„šæœ¬
â”œâ”€â”€ rag_knowledge_base/            # RAGçŸ¥è¯†åº“ç›®å½•
â”‚   â”œâ”€â”€ knowledge_base.pkl        # çŸ¥è¯†åº“æ–‡ä»¶
â”‚   â””â”€â”€ encoder/                   # embeddingæ¨¡å‹
â””â”€â”€ data/
    â””â”€â”€ test/
        â””â”€â”€ 1B/
            â”œâ”€â”€ WildGuardTest_HSDPO_NoRAG/      # ä¸å¸¦RAGçš„é¢„æµ‹
            â”‚   â””â”€â”€ generated_predictions.jsonl
            â””â”€â”€ WildGuardTest_HSDPO_WithRAG/    # å¸¦RAGçš„é¢„æµ‹
                â””â”€â”€ generated_predictions.jsonl
```

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ å·²ç»å®Œæˆäº†RAGçš„é›†æˆå’Œè¯„ä¼°ã€‚å¦‚æœRAGæå‡äº†æ¨¡å‹æ•ˆæœï¼Œæ­å–œä½ ï¼å¦‚æœæ•ˆæœä¸ç†æƒ³ï¼Œå¯ä»¥å°è¯•ï¼š

1. è°ƒæ•´top_kå‚æ•°
2. ä½¿ç”¨æ›´å¤š/æ›´å¥½çš„è®­ç»ƒæ•°æ®æ„å»ºçŸ¥è¯†åº“
3. å°è¯•ä¸åŒçš„embeddingæ¨¡å‹
4. è°ƒæ•´RAGä¸Šä¸‹æ–‡çš„æ ¼å¼

ç¥ä½ å®éªŒé¡ºåˆ©ï¼ğŸš€

